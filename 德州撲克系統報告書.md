# 德州撲克賽事管理系統 - 技術報告書

**報告日期：** 2024年  
**報告對象：** 德州撲克店長  
**系統名稱：** Lucky Poker 賽事管理系統

---

## 目錄

1. [系統架構與技術棧](#1-系統架構與技術棧)
2. [安全措施](#2-安全措施)
3. [後續維護問題與解決方案](#3-後續維護問題與解決方案)
4. [目前問題與改進建議](#4-目前問題與改進建議)

---

## 1. 系統架構與技術棧

### 1.1 前端技術

本系統採用現代化的前端技術架構，確保系統穩定、快速且易於維護：

#### **核心框架**
- **React 18.2.0** - 業界領先的前端框架
  - 提供組件化開發，代碼結構清晰
  - 支援高效能渲染和狀態管理
  - 擁有龐大的生態系統和社群支援

- **TypeScript 5.2.2** - 類型安全的 JavaScript
  - 在開發階段就能發現錯誤，減少運行時問題
  - 提供更好的代碼提示和文檔
  - 提高代碼可維護性

#### **構建工具**
- **Vite 5.0.8** - 新一代前端構建工具
  - 極快的開發伺服器啟動速度（秒級）
  - 熱模組替換（HMR），修改代碼即時看到效果
  - 優化的生產環境構建，檔案體積小、載入快

#### **UI 框架**
- **Tailwind CSS 3.3.6** - 實用優先的 CSS 框架
  - 快速開發美觀的介面
  - 響應式設計，自動適配手機、平板、電腦
  - 自訂主題，符合撲克場的專業風格

#### **輔助工具**
- **html2canvas 1.4.1** - 圖片導出功能
  - 將結算表轉換為 PNG 圖片
  - 方便分享到 Line 群組或列印

### 1.2 數據存儲架構

系統採用**雙層存儲架構**，確保數據安全與可用性：

#### **雲端存儲（主要）**
- **Firebase Firestore** - Google 提供的雲端資料庫
  - 即時同步：多台設備同時使用時，數據自動同步
  - 跨設備存取：電腦、手機、平板都能看到最新數據
  - 自動備份：數據存儲在 Google 雲端，不會遺失
  - 免費額度：每日 50,000 次讀取、20,000 次寫入（一般使用足夠）

#### **本地存儲（備份）**
- **localStorage** - 瀏覽器本地存儲
  - 當網路中斷時，系統自動切換到本地模式
  - 所有功能正常運作，不影響使用
  - 網路恢復後自動同步到雲端

**優勢：**
- ✅ 離線可用：即使沒有網路也能正常使用
- ✅ 數據不丟失：本地和雲端雙重備份
- ✅ 自動同步：多設備間數據自動保持一致

### 1.3 部署架構

- **Vercel** - 專業的前端部署平台
  - 自動部署：代碼更新後自動部署
  - 全球 CDN：快速載入，無論在哪裡使用都很快
  - HTTPS 加密：自動提供安全連線
  - 免費方案：適合中小型使用

### 1.4 系統功能模組

系統包含以下核心功能模組：

1. **賽事管理模組**
   - 支援 5 種標準賽事類型（600/1200/3400/6600/11000）
   - 自訂賽事類型（可設定入場費、起始碼量等）
   - 賽事歷史記錄查詢

2. **玩家管理模組**
   - 會編快速輸入（虛擬鍵盤）
   - 玩家歷史記錄自動顯示
   - 多買入管理
   - 碼量即時更新

3. **碼量校驗模組**
   - 自動計算理論總碼量
   - 即時比對實際碼量
   - 異常警告提示（紅色閃爍）

4. **財務統計模組**
   - 總入場費計算
   - 獎金池計算（支援 ICM 分配）
   - 管理費計算
   - 支付方式統計

5. **結算導出模組**
   - 生成專業結算表圖片
   - 一鍵分享功能

6. **用戶管理模組**
   - 多用戶帳號管理
   - 管理員權限控制
   - 操作日誌記錄

7. **安全設定模組**
   - IP 地址授權限制
   - 登入失敗保護

---

## 2. 安全措施

### 2.1 已實施的安全措施

#### **身份驗證與授權**
✅ **登入系統**
- 用戶名和密碼驗證
- 24 小時會話過期機制（自動登出）
- 路由保護（未登入無法訪問系統）

✅ **權限管理**
- 管理員與一般用戶權限分離
- 受保護帳號機制（防止刪除特定重要帳號）
- 操作權限檢查（只有管理員可進行敏感操作）

✅ **登入保護**
- 登入失敗次數限制（5 次失敗後鎖定 15 分鐘）
- 防止暴力破解攻擊
- 自動清除失敗記錄機制

#### **輸入驗證與清理**
✅ **XSS 防護**
- 所有用戶輸入自動清理 HTML 標籤
- 特殊字符自動轉義（`<`, `>`, `&` 等）
- 防止惡意腳本注入

✅ **數據格式驗證**
- 會編格式驗證（只允許數字）
- 用戶名格式驗證（3-20 字符，字母數字下劃線）
- 密碼強度驗證（至少 8 位，包含字母和數字）
- 數字輸入驗證（防止非數字輸入）

✅ **SQL 注入防護**
- 雖然使用 NoSQL 資料庫，但仍實施輸入清理
- 移除可能導致數據解析問題的特殊字符

#### **網路安全**
✅ **IP 地址授權**
- 可設定授權 IP 地址範圍
- 只有授權 IP 才能進行帳務更動
- 防止未授權的網路環境進行敏感操作

✅ **會話管理**
- 會話狀態存儲在本地
- 自動過期機制
- 登出時清除所有會話數據

#### **操作審計**
✅ **操作日誌**
- 記錄所有重要操作（新增玩家、修改碼量、刪除玩家等）
- 記錄操作者、操作時間、操作內容
- 可追蹤所有變更歷史

### 2.2 安全注意事項

⚠️ **目前存在的安全限制**

由於系統採用**前端架構**（所有代碼在瀏覽器執行），存在以下安全限制：

1. **客戶端驗證限制**
   - 所有驗證邏輯在瀏覽器執行
   - 技術上可通過修改瀏覽器代碼繞過（需要技術知識）
   - **建議**：重要操作應在後端進行二次驗證

2. **密碼存儲方式**
   - 目前密碼以明文形式存儲（雖然有加密傳輸）
   - **建議**：應使用密碼哈希（bcrypt）存儲

3. **Firebase 安全規則**
   - 目前使用開放式規則（`allow read, write: if true`）
   - 這是因為系統使用自訂身份驗證，而非 Firebase Authentication
   - **建議**：如需更高安全性，可考慮遷移到 Firebase Authentication

### 2.3 安全建議（未來改進）

#### **高優先級**
1. **密碼哈希存儲**
   - 使用 bcrypt 對密碼進行哈希
   - 即使數據被洩露，密碼也無法被直接讀取

2. **環境變量管理**
   - 將 Firebase API Key 移至環境變量
   - 避免在代碼中硬編碼敏感信息

3. **輸入驗證強化**
   - 已在實施中，可進一步加強

#### **中優先級**
4. **服務器端驗證**
   - 建立後端 API 進行二次驗證
   - 使用 JWT（JSON Web Tokens）進行會話管理

5. **CSRF 保護**
   - 實施跨站請求偽造保護
   - 使用 CSRF token 驗證請求來源

#### **低優先級**
6. **雙因素認證（2FA）**
   - 增加簡訊或郵件驗證碼
   - 提高帳號安全性

7. **定期安全掃描**
   - 使用自動化工具掃描安全漏洞
   - 及時更新依賴套件

---

## 3. 後續維護問題與解決方案

### 3.1 Firebase 相關問題

#### **問題 1：Firebase 配額超限**
**可能情況：**
- 每日讀寫次數超過免費額度（50,000 讀取/20,000 寫入）
- 數據存儲空間超過 1GB

**解決方案：**
1. **監控使用量**
   - 定期檢查 Firebase Console 的使用統計
   - 設定使用量警告通知

2. **優化數據讀寫**
   - 減少不必要的即時監聽
   - 使用數據快取機制
   - 批量操作減少寫入次數

3. **升級方案**
   - 如果確實需要，可升級到 Firebase 付費方案
   - 或考慮遷移到其他資料庫（如 MongoDB Atlas）

4. **降級處理**
   - 系統已支援自動降級到本地存儲
   - 即使 Firebase 配額超限，系統仍可正常運作（僅失去跨設備同步）

#### **問題 2：Firebase 連接錯誤（404/400）**
**可能情況：**
- Firestore 安全規則配置不正確
- 網路連接問題
- Firebase 服務暫時中斷

**解決方案：**
1. **檢查安全規則**
   - 登入 Firebase Console
   - 確認 Firestore 規則為：`allow read, write: if true;`
   - 點擊「發布」保存規則

2. **網路問題處理**
   - 系統會自動重試連接
   - 自動降級到本地存儲模式
   - 網路恢復後自動同步

3. **錯誤處理機制**
   - 系統已實施錯誤過濾機制
   - 非關鍵錯誤會被自動忽略
   - 不影響正常使用

#### **問題 3：數據同步延遲**
**可能情況：**
- 網路速度慢
- 數據量大
- 多設備同時寫入

**解決方案：**
1. **優化網路**
   - 確保穩定的網路連接
   - 使用有線網路而非 Wi-Fi（如可能）

2. **數據分頁**
   - 大量數據時使用分頁載入
   - 減少單次讀取的數據量

3. **衝突解決**
   - 系統使用「最後寫入優先」策略
   - 重要操作建議單設備進行

### 3.2 瀏覽器相容性問題

#### **問題：舊版瀏覽器不支援**
**可能情況：**
- 使用 IE 或非常舊的瀏覽器
- 某些功能無法正常運作

**解決方案：**
1. **建議使用現代瀏覽器**
   - Chrome 90+（推薦）
   - Firefox 88+
   - Safari 14+
   - Edge 90+

2. **降級處理**
   - 系統會顯示瀏覽器不支援提示
   - 建議用戶更新瀏覽器

3. **測試清單**
   - 定期在不同瀏覽器測試
   - 確保核心功能正常運作

### 3.3 數據備份與恢復

#### **問題：數據遺失風險**
**可能情況：**
- 瀏覽器清除數據
- Firebase 數據被誤刪
- 設備故障

**解決方案：**
1. **自動備份機制**
   - 系統同時存儲在本地和雲端
   - 雙重備份降低遺失風險

2. **手動備份**
   - 定期從 Firebase Console 導出數據
   - 保存重要賽事記錄的截圖

3. **數據恢復流程**
   - 從 Firebase Console 恢復雲端數據
   - 或從本地存儲恢復（如果存在）

### 3.4 依賴套件更新

#### **問題：套件過時或安全漏洞**
**可能情況：**
- 依賴套件有安全漏洞
- 新版本不相容

**解決方案：**
1. **定期更新**
   - 每季度檢查一次依賴更新
   - 使用 `npm audit` 檢查安全漏洞

2. **測試更新**
   - 在測試環境先測試更新
   - 確認所有功能正常後再部署

3. **版本鎖定**
   - 使用 `package-lock.json` 鎖定版本
   - 避免自動更新導致問題

### 3.5 效能優化

#### **問題：系統運行變慢**
**可能情況：**
- 數據量過大
- 瀏覽器記憶體不足
- 網路速度慢

**解決方案：**
1. **數據清理**
   - 定期清理舊的賽事記錄
   - 只保留必要的歷史數據

2. **程式碼優化**
   - 使用 React.memo 減少不必要的渲染
   - 實施虛擬滾動（如果列表很長）

3. **快取機制**
   - 使用瀏覽器快取
   - 減少重複的數據讀取

### 3.6 用戶支援

#### **問題：用戶操作問題**
**可能情況：**
- 用戶不熟悉系統操作
- 遇到錯誤不知道如何處理

**解決方案：**
1. **使用文檔**
   - 提供詳細的使用手冊（README.md, QUICKSTART.md）
   - 常見問題解答（FAQ）

2. **錯誤提示**
   - 系統提供清晰的錯誤訊息
   - 建議解決方案

3. **培訓**
   - 定期進行用戶培訓
   - 建立操作流程文檔

---

## 4. 目前問題與改進建議

### 4.1 已知問題

#### **問題 1：密碼明文存儲** ✅ **已解決**
**嚴重程度：** 🔴 高  
**影響：** 如果 localStorage 被讀取，所有密碼都會洩露

**解決方案：**
- ✅ 已實施使用 Web Crypto API 的 PBKDF2 算法對密碼進行哈希存儲
- ✅ 每個密碼使用唯一的鹽值（salt），防止彩虹表攻擊
- ✅ 驗證時使用時間安全的比較方法，防止時序攻擊
- ✅ 自動遷移舊格式：系統會自動將現有的明文密碼轉換為哈希格式
- ✅ 向後兼容：舊的同步函數仍然可以工作，但會觸發異步遷移

**技術細節：**
- 使用 PBKDF2 算法，迭代 100,000 次
- 使用 SHA-256 哈希函數
- 每個密碼使用 16 字節隨機鹽值
- 哈希值長度：256 位（32 字節）

**安全性提升：**
- 即使 localStorage 被讀取，攻擊者也只能看到哈希值，無法還原原始密碼
- 即使兩個用戶使用相同密碼，由於鹽值不同，哈希值也不同
- 符合現代密碼存儲最佳實踐

#### **問題 2：Firebase API Key 硬編碼** ✅ **已解決**
**嚴重程度：** 🟡 中  
**影響：** API Key 暴露在客戶端代碼中

**解決方案：**
- ✅ 已移除所有硬編碼的 Firebase 配置值
- ✅ 創建 `.env.example` 模板文件，方便配置
- ✅ 更新配置讀取邏輯，只從環境變量讀取
- ✅ 確保 `.env` 文件已在 `.gitignore` 中（不會被提交到版本控制）
- ✅ 添加配置驗證邏輯，檢查必需配置項是否已設置
- ✅ 更新文檔說明如何配置環境變量
- ✅ 創建部署指南（`DEPLOYMENT.md`）說明如何在各平台設置環境變量

**安全改進：**
- 所有 Firebase 配置現在必須通過環境變量提供
- 開發環境：使用 `.env` 文件（本地，不提交到 Git）
- 生產環境：在部署平台（如 Vercel）設置環境變量
- 代碼中不再包含任何硬編碼的敏感信息

**使用說明：**
1. 複製 `.env.example` 為 `.env`
2. 填入您的 Firebase 配置信息
3. 確保 `.env` 文件不被提交到版本控制（已在 `.gitignore` 中）

**注意事項：**
- 雖然 Firebase Web API Key 在客戶端可見是正常的（因為需要在前端使用）
- 但使用環境變量可以：
  - 避免在代碼庫中暴露配置
  - 方便不同環境使用不同配置
  - 符合最佳實踐
  - 在 Firebase Console 中設置 API Key 限制（僅允許特定域名使用）

#### **問題 3：客戶端驗證限制**
**嚴重程度：** 🟡 中  
**影響：** 技術上可繞過前端驗證

**改進方案：**
- 建立後端 API 進行服務器端驗證
- 使用 JWT 進行會話管理
- 預計工作量：1-2 週（需要後端開發）

#### **問題 4：Firestore 安全規則過於開放**
**嚴重程度：** 🟡 中  
**影響：** 任何人都可以讀寫數據（如果知道 Firebase 配置）

**改進方案：**
- 遷移到 Firebase Authentication
- 實施基於用戶的安全規則
- 預計工作量：1 週

### 4.2 功能改進建議

#### **高優先級改進**

1. **數據導出功能增強**
   - 支援 Excel 格式導出
   - 支援 PDF 格式導出
   - 批量導出多個賽事
   - **預期效益：** 方便財務報表製作

2. **搜尋功能**
   - 按會編搜尋玩家
   - 按日期搜尋賽事
   - 按玩家名稱搜尋
   - **預期效益：** 快速查找歷史記錄

3. **統計報表**
   - 玩家參賽統計
   - 賽事收入統計
   - 月度/年度報表
   - **預期效益：** 數據分析與決策支援

#### **中優先級改進**

4. **手機版優化**
   - 響應式設計優化
   - 觸控操作優化
   - 離線功能增強
   - **預期效益：** 提升手機使用體驗

5. **多語言支援**
   - 繁體中文
   - 簡體中文
   - 英文
   - **預期效益：** 擴大用戶群

6. **通知功能**
   - 賽事開始提醒
   - 碼量異常提醒
   - 系統更新通知
   - **預期效益：** 及時掌握重要信息

#### **低優先級改進**

7. **主題切換**
   - 深色/淺色主題
   - 自訂顏色主題
   - **預期效益：** 個人化體驗

8. **快捷鍵支援**
   - 鍵盤快捷鍵操作
   - 提高操作效率
   - **預期效益：** 快速操作

9. **數據視覺化**
   - 圖表展示統計數據
   - 趨勢分析
   - **預期效益：** 直觀了解數據

### 4.3 技術債務

#### **代碼優化**
1. **組件拆分**
   - 部分組件過大，建議拆分為更小的組件
   - 提高代碼可維護性

2. **錯誤處理**
   - 統一錯誤處理機制
   - 更好的錯誤訊息提示

3. **測試覆蓋**
   - 目前缺少自動化測試
   - 建議添加單元測試和整合測試

#### **效能優化**
1. **代碼分割**
   - 實施路由級代碼分割
   - 減少初始載入時間

2. **圖片優化**
   - 導出圖片壓縮優化
   - 減少檔案大小

3. **資料庫索引**
   - 為常用查詢添加 Firestore 索引
   - 提高查詢速度

### 4.4 長期規劃

#### **階段一：安全強化（1-2 個月）**
- 實施密碼哈希
- 環境變量管理
- 輸入驗證強化

#### **階段二：功能擴展（2-3 個月）**
- 數據導出增強
- 搜尋功能
- 統計報表

#### **階段三：後端開發（3-6 個月）**
- 建立後端 API
- 服務器端驗證
- 更嚴格的安全控制

#### **階段四：進階功能（6-12 個月）**
- 數據視覺化
- 進階統計分析
- 自動化報表

---

## 總結

### 系統優勢：
1. ✅ **現代化技術棧** - 使用業界領先的前端技術
2. ✅ **雙重數據備份** - 本地+雲端，數據安全有保障
3. ✅ **離線可用** - 網路中斷仍可正常使用
4. ✅ **跨設備同步** - 多設備數據自動同步
5. ✅ **響應式設計** - 適配各種設備
6. ✅ **基本安全措施** - 身份驗證、輸入驗證、操作日誌

### 需要關注的領域：
1. ⚠️ **安全強化** - 密碼存儲、服務器端驗證
2. ⚠️ **功能擴展** - 數據導出、搜尋、統計
3. ⚠️ **維護計劃** - 定期更新、備份、監控

### 建議優先級：
1. **立即實施**：密碼哈希、環境變量管理
2. **短期規劃**：功能擴展、手機版優化
3. **長期規劃**：後端開發、進階功能

---

## 附錄

### A. 技術支援聯繫方式
- **開發團隊**：[請填入聯繫方式]
- **Firebase 支援**：https://firebase.google.com/support
- **Vercel 支援**：https://vercel.com/support

### B. 相關文檔
- `README.md` - 系統使用說明
- `QUICKSTART.md` - 快速啟動指南
- `FIREBASE_SETUP.md` - Firebase 設置指南
- `SECURITY_AUDIT.md` - 安全審計報告

### C. 系統版本信息
- **當前版本**：1.0.0
- **最後更新**：2024年
- **Node.js 要求**：>= 18.0.0

---

**報告結束**

如有任何問題或需要進一步說明，請隨時聯繫開發團隊。
